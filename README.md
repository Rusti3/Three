# Three.js Train Demo

Сайт на `three.js`, где поезд автоматически едет по рельсам в 3D-сцене.

## Run

```bash
npm install
npm run dev
```

## Test

```bash
npm run test
```

## Version Summary

### v0.2.5 (2026-02-23)

Что сделано:
- Добавлена поддержка анимации колес поезда.
- Если в `the_polar_express_locomotive.glb` есть встроенные анимации, они проигрываются через `AnimationMixer`.
- Если анимаций нет, колеса вращаются программно (поиск по имени `wheel|tire|tyre`).
- Добавлены unit-тесты для поиска колес и вращения (`src/game/trainAnimation.test.ts`).

Зачем эти функции:
- Поезд выглядит живее во время движения.
- Есть fallback на случай, если у модели нет встроенной анимации.

Что изменилось для пользователя:
- Колеса вращаются во время движения поезда.

### v0.2.4 (2026-02-23)

Что сделано:
- Увеличен максимальный zoom-out камеры до `20000`.
- Увеличена чувствительность колесика мыши для zoom, чтобы быстрее отдаляться на большие дистанции.
- Добавлен unit-тест на clamp zoom к `20000`.

Зачем эти функции:
- Можно отдалять камеру значительно дальше прежнего лимита и быстрее менять масштаб просмотра.

Что изменилось для пользователя:
- Колесо мыши теперь может увести камеру очень далеко (до `20000`).

### v0.2.3 (2026-02-23)

Что сделано:
- Увеличен диапазон zoom-out камеры: теперь можно отдаляться заметно дальше.
- Лимит максимального zoom увеличен:
  - default в `followCamera` до `5.5`,
  - в сцене (`main.ts`) до `5`.
- Обновлен e2e smoke: добавлена проверка, что камера реально может отдалиться дальше `zoom > 3`.

Зачем эти функции:
- При боковом ракурсе стало удобнее смотреть весь поезд/участок рельс целиком.

Что изменилось для пользователя:
- Колесо мыши теперь отдаляет камеру сильнее, чем раньше.

### v0.2.2 (2026-02-23)

Что сделано:
- Добавлена возможность приближения/отдаления камеры колесом мыши.
- `followCamera` расширен zoom API:
  - `zoomBy(delta)`
  - `setZoom(value)`
  - `getZoom()`
- Добавлены ограничения zoom (`minZoom`, `maxZoom`) и начальное значение (`initialZoom`).
- Добавлен unit-тест zoom-логики камеры (`src/game/followCamera.test.ts`).
- E2E smoke дополнен проверкой, что zoom меняется от колесика мыши.
- Обновлен HUD: показана подсказка `mouse wheel = zoom`.

Зачем эти функции:
- Пользователь может быстро менять ракурс без правок кода.
- Ограничения zoom защищают от слишком близкой/слишком далекой камеры.

Что изменилось для пользователя:
- Колесо мыши теперь приближает и отдаляет боковую follow-камеру во время движения поезда.

### v0.2.1 (2026-02-23)

Что сделано:
- Камера переведена в боковой обзор (side-view), теперь смотрит на поезд сбоку в движении.
- `followCamera` расширен параметром `sideOffset`, чтобы явно управлять боковым смещением камеры.
- Добавлены тесты для side-view камеры (`src/game/followCamera.test.ts`).
- Усилен тест масштаба поезда: longest side сравнивается с целевым размером.

Зачем эти функции:
- Боковой обзор делает движение поезда по рельсам более наглядным.
- Отдельный `sideOffset` упрощает настройку ракурса.
- Проверка размера в тестах фиксирует целевой масштаб и защищает от случайной регрессии.

Что изменилось для пользователя:
- Камера теперь следует за поездом сбоку, а не сзади.
- Масштаб поезда подстраивается по целевому параметру `TRAIN_TARGET_LONGEST_SIDE`.

### v0.2.0 (2026-02-23)

Что сделано:
- Полностью удалена логика машины и клавиатурного управления.
- Добавлены новые модели сцены:
  - `the_polar_express_locomotive.glb` (поезд),
  - `railway.glb` (рельсы).
- Реализована автоподгонка моделей через `Box3` (масштаб, центрирование, позиционирование, тени).
- Добавлен модуль движения `trainMotion`: поезд едет только вперед по оси `Z` и циклически возвращается в начало пути.
- Обновлен рендер-сценарий: follow-camera теперь следует за поездом.
- Переписаны тесты:
  - unit для движения поезда и подготовки моделей (`trainMotion`, `trainModel`, `railModel`),
  - e2e smoke на автозагрузку моделей и автоматическое движение без клавиатуры.
- Удалены устаревшие файлы машины (`controls`, `vehicle`, `carModel`, `carPlaceholder` и их тесты).

Зачем эти функции:
- Проект теперь соответствует новому сценарию: «поезд по рельсам без ручного управления».
- Автоподгонка `Box3` уменьшает ручные правки трансформаций для новых моделей.
- Упрощенная логика движения делает поведение предсказуемым и стабильным.

Что изменилось для пользователя:
- Больше нет управления машиной.
- На сцене загружаются рельсы и локомотив.
- Поезд автоматически едет вперед по рельсам и зацикливается.

### v0.1.2 (2026-02-22)

Что сделано:
- Исправлено направление поворота: `D` теперь поворачивает вправо, `A` — влево.
- Увеличен масштаб модели машины `sample.glb` в 20 раз (с текущего коэффициента).
- Обновлены тесты под новое поведение управления и масштаб модели.

Зачем эти функции:
- Направление поворота теперь соответствует ожидаемому управлению.
- Модель стала заметно крупнее и лучше читается в сцене.

Что изменилось для пользователя:
- Нажатие `D` поворачивает машину вправо.
- Машина отображается значительно больше.

### v0.1.1 (2026-02-22)

Что сделано:
- Подключена реальная модель машины `sample.glb` через `GLTFLoader`.
- Добавлен модуль `src/game/carModel.ts` для загрузки и базовой подготовки модели (масштаб, смещение, тени).
- В `src/main.ts` заменена постоянная заглушка: теперь сначала пытаемся загрузить `sample.glb`, а заглушка остается как fallback при ошибке загрузки.
- Расширен debug API в `window.__THREE_DRIVE__` флагом `isCarModelLoaded`.
- Добавлены тесты под новую функциональность:
  - `src/game/carModel.test.ts` (unit для URL и подготовки модели),
  - e2e smoke дополнен проверкой фактической загрузки GLB.

Зачем эти функции:
- Пользователь теперь видит реальную 3D-модель машины, а не примитив.
- Отдельный модуль загрузки упрощает будущую замену/настройку модели.
- Fallback сохраняет работоспособность сцены при проблемах с ассетом.

Что изменилось для пользователя:
- Визуально машина стала реальной моделью из `sample.glb`.
- Управление и поведение движения остались прежними (`W/A/S/D`, `R`).

### v0.1.0 (2026-02-22)

Что сделано:
- Поднят проект на `Vite + TypeScript + Three.js`.
- Добавлена 3D-сцена: свет, земля, сетка и камера, которая следует за машиной.
- Реализована аркадная езда на `W/A/S/D` и стрелках.
- Добавлен `R` для сброса позиции/угла/скорости.
- Временная модель машины сделана как 3D-заглушка (группа мешей), готовая к замене на `GLB/GLTF`.
- Добавлены автотесты:
  - unit (`Vitest`) для логики движения и клавиатурных контролов;
  - e2e smoke (`Playwright`) для проверки рендера и движения в браузере.

Зачем эти функции:
- Разделение на модули `controls`, `vehicle`, `followCamera` упрощает развитие и замену модели без переписывания геймплея.
- Тесты снижают риск поломок при доработках.

Что изменилось для пользователя:
- Пользователь открывает страницу и сразу может ездить на машине по сцене с follow-камерой.
- Есть понятный HUD с подсказкой управления.

## Как настроить правильный размер поезда

1. Открой `src/game/trainModel.ts`.
2. Измени `TRAIN_TARGET_LONGEST_SIDE`.
3. Если поезд слишком маленький, увеличь значение. Если слишком большой, уменьши.
4. Запусти `npm run test:unit` и проверь, что тест `trainModel.test.ts` проходит.
5. Для визуальной проверки запусти `npm run dev` и оцени размер поезда относительно `railway.glb`.
